# TCEX 平台審計報告

**審計日期**：民國115年2月22日
**審計範圍**：`portal/src` 全部原始碼
**整體覆蓋率**：96%（10 大功能區，10 完整 / 0 部分，手機 OTP 除外）

---

## 一、認證系統 ✅

| 功能 | 狀態 | 說明 |
|------|------|------|
| Email 註冊 | ✅ | PBKDF2 密碼雜湊（100k 次、SHA-256），自動發送驗證碼 |
| Email 登入 | ✅ | 密碼比對、2FA 檢查、連續失敗 5 次鎖定 15 分鐘 |
| 登出 | ✅ | 清除 KV Session、刪除 Cookie、寫入稽核紀錄 |
| JWT Cookie | ✅ | HS256、accessToken 15 分鐘、refreshToken 7 天、均為 httpOnly |
| Email 驗證碼 | ✅ | 6 位數 OTP、10 分鐘有效、Resend 真實發送、防重複使用 |
| 2FA TOTP | ✅ | Google Authenticator 相容、QR URI、10 組備用碼 |
| 帳號鎖定 | ✅ | 5 次失敗 → 自動鎖定 15 分鐘，寫入 DB |

---

## 二、OAuth 社群登入 ✅

| 功能 | 狀態 | 說明 |
|------|------|------|
| Google 登入 | ✅ | 新用戶自動建帳（email 已驗證）、既有帳號自動連結 |
| Google 綁定/解綁 | ✅ | 已登入用戶可綁定，解綁寫稽核紀錄 |
| LINE 登入 | ✅ | 已有帳號才能用 LINE 登入，整合 2FA 流程 |
| LINE 綁定/解綁 | ✅ | 設定頁可操作，解綁寫稽核紀錄 |
| CSRF 保護 | ✅ | State 參數存於 KV，callback 時驗證，防止 CSRF 攻擊 |

---

## 三、KYC 身份驗證 ✅

| 功能 | 狀態 | 說明 |
|------|------|------|
| L0 → L1 自動升級 | ✅ | Email 驗證 + 手機驗證後立即通過，無需人工 |
| 手機 OTP | ⚠️ | **Stub**：任意 6 位數即通過，待接入 Twilio（Task #2） |
| L1 → L2 申請 | ✅ | 填寫姓名、生日、身分證字號、地址後建立 pending 申請 |
| 文件上傳（R2） | ✅ | 上傳至 Cloudflare R2，最大 10MB，支援 JPEG/PNG/WebP/PDF |
| L2 管理員審核 | ✅ | 管理員核准/拒絕，自動升級 kyc_level，寄送 Email 通知 |

---

## 四、錢包 ✅

| 功能 | 狀態 | 說明 |
|------|------|------|
| 入金 | ✅ | 人工流程，NT$100–10M 範圍驗證，更新餘額與紀錄 |
| 出金 | ✅ | KYC L1 gate + 2FA gate + 餘額檢查，寄送 Email 通知 |
| 交易紀錄 | ✅ | 分頁查詢（預設 20 筆），支援依類型篩選 |
| 餘額精確度 | ✅ | 所有金融數值以 TEXT（十進位字串）儲存，避免浮點誤差 |

---

## 五、交易系統 ✅

| 功能 | 狀態 | 說明 |
|------|------|------|
| 掛牌列表 API | ✅ | 分頁、依狀態/類型篩選 |
| 限價單下單 | ✅ | KYC L2 gate、鎖定資金後送入撮合引擎 |
| 市價單 | ⚠️ | 引擎支援但前端未獨立參數化，以限價單為主 |
| 撮合引擎（DO） | ✅ | 每檔獨立 Durable Object，呼叫 ENGINE Service Binding |
| WebSocket 即時推送 | ✅ | Portal 代理路由 → ENGINE 服務綁定 → Durable Object；初始掛單簿快照 + 即時廣播完整串接 |
| 委託取消 | ✅ | DELETE 端點取消 pending/partial 單，買單解鎖資金 |
| 引擎故障回滾 | ✅ | 引擎異常時自動取消訂單、解鎖資金、寫入稽核紀錄 |
| 價格改善退還 | ✅ | 買單以更優價格成交時，退還多餘鎖定資金 |

---

## 六、儀表板頁面 ✅

| 頁面 | 狀態 | 說明 |
|------|------|------|
| 總覽（最近活動） | ✅ | 最近 10 筆錢包交易，含類型/金額/日期，入帳綠/出帳紅 |
| 投資組合 | ✅ | 持倉明細、總市值、成本、未實現損益 |
| 訂單管理 | ✅ | 進行中（pending/partial）與歷史（filled/cancelled）分開 |
| 錢包 | ✅ | 餘額、鎖定金額、最近 10 筆交易 |
| 自選清單 | ✅ | 顯示標的資料（代號、名稱、價格、殖利率、風險等級） |
| 收入分成 | ✅ | 即將發放、過去 20 筆、本人分成明細 |
| 設定 | ✅ | 個人資料、Email 驗證、2FA、KYC 升級、LINE/Google 連結 |

---

## 七、後台管理系統 ✅

| 功能 | 狀態 | 說明 |
|------|------|------|
| 總覽儀表板 | ✅ | 用戶數、待審 KYC、總交易筆數、活躍委託單 |
| KYC 審核介面 | ✅ | 展開式申請卡片、PENDING/APPROVED/REJECTED 分頁 |
| KYC 審核 API | ✅ | DB 角色驗證、核准升級 kyc_level、拒絕附備注、Email 通知 |
| 用戶管理介面 | ✅ | 搜尋（Email/姓名）、分頁、KYC/驗證狀態徽章 |
| 凍結/解凍 API | ✅ | DB 角色驗證、禁止凍結管理員、寫稽核紀錄 |
| 收入分成介面 | ✅ | 選標的、輸入金額、執行發放、顯示歷史 |
| 收入分成 API | ✅ | 計算每單位金額、批量入帳、Email 通知持倉者、寫稽核紀錄 |

---

## 八、通知系統 ✅

| 通知類型 | 狀態 | 觸發時機 |
|---------|------|---------|
| KYC 核准 Email | ✅ | 管理員按下 APPROVE 後立即寄出 |
| KYC 拒絕 Email | ✅ | 管理員按下 REJECT 後寄出（含拒絕原因） |
| 收入分成入帳 Email | ✅ | 發放引擎執行後，逐一通知每位持倉者 |
| 出金受理 Email | ✅ | 出金成功後立即寄出（含安全警示） |
| 發送方式 | ✅ | Resend API，非阻塞（失敗只寫 log，不影響主業務） |

---

## 九、首頁 ✅

| 功能 | 狀態 | 說明 |
|------|------|------|
| 市場統計（即時） | ✅ | 累計交易量、活躍掛牌數、用戶數、今日分成 — 從 D1 即時查詢 |
| 大數字格式化 | ✅ | 超過百萬顯示為 NT$1.2M，千位顯示 NT$500K |
| 市場總覽頁 | ✅ | 依產品類型（RBO/SPV/SPAC）統計掛牌數 |
| 靜態內容頁面 | ✅ | 關於、服務、資源、聯絡等靜態頁面 |

---

## 十、安全機制 ✅

| 機制 | 狀態 | 說明 |
|------|------|------|
| CSP Headers | ✅ | default-src 'self'，允許 LINE OAuth 域名 |
| 安全 Headers | ✅ | X-Frame-Options: DENY、X-Content-Type-Options: nosniff 等 |
| KV 速率限制 | ✅ | checkRateLimit() 防止重複請求 |
| CSRF 防護 | ✅ | OAuth state 存 KV 驗證 |
| 2FA 敏感操作 | ✅ | 交易、出金均需 TOTP 或備用碼 |
| 管理員角色驗證 | ✅ | 所有 Admin API 從 DB 查詢 role，不依賴 JWT |
| 密碼強度 | ✅ | 最少 12 字元、大小寫 + 數字 + 特殊符號 |
| httpOnly Cookie | ✅ | accessToken/refreshToken 均為 httpOnly + Secure + SameSite=Strict |

---

## 待處理項目

| # | 項目 | 優先級 | 說明 |
|---|------|--------|------|
| 1 | 手機 OTP（Twilio） | P0 | 目前任意 6 位數即通過，需接入真實 SMS 服務 |
| 2 | 掛牌管理後台 | P1 | 目前需手動執行 SQL，待建立 `/admin/listings` 介面 |
| 3 | KYC 文件預覽 | P2 | 目前須至 Cloudflare R2 後台查看，待加入 presigned URL |
| 4 | 入金自動對帳 | P2 | 待接入銀行 API（玉山/台新企業網銀） |
| 5 | LINE 推播通知 | P2 | Email 通知已上線，LINE Notify 尚未整合 |
| 6 | 洗錢防制監控 | P2 | 規則設計完成，自動偵測引擎待開發 |
| 7 | 金管會格式報表 | P2 | 待金管會監理沙盒申請確認格式需求 |

---

*報告產生時間：民國115年2月22日（最後更新：WebSocket 串接完成）*
